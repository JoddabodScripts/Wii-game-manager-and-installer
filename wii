#!/bin/bash

# Ultimate Wii WBFS Manager & Converter - /usr/bin/wii
# Now targeting JWII (your bigger USB drive!)
# Usage: wii

DOWNLOADS_DIR="$HOME/Downloads"
SOURCE_DIR="/run/media/joud/JWII/WBFS"
DEST_DIR="/run/media/joud/JWII/wbfs"
LOG_FILE="/tmp/wii_manager_$(date +%Y%m%d_%H%M%S).log"

# Simple ASCII art - no colors to avoid issues
BORDER="‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
BORDER_MID="‚ïë"
BORDER_BOTTOM="‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

# Logging function
log() {
    echo "$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Show help
show_help() {
    echo "$BORDER"
    echo "$BORDER_MID                WII GAME MANAGER                       $BORDER_MID"
    echo "$BORDER_MID                =================                       $BORDER_MID"
    echo "$BORDER_BOTTOM"
    echo ""
    echo "USAGE:"
    echo "  wii                    # Run the full process"
    echo "  wii --help             # Show this help"
    echo "  wii --status           # Show current game library status"
    echo "  wii --clean            # Remove duplicate source files"
    echo "  wii --paths            # Show current directory paths"
    echo ""
    echo "CURRENT PATHS:"
    echo "  üì• Downloads: $DOWNLOADS_DIR"
    echo "  üì¶ Source WBFS: $SOURCE_DIR"
    echo "  üéÆ USB Loader GX: $DEST_DIR"
    echo "  üìù Log file: $LOG_FILE"
    echo ""
    echo "WHAT IT DOES:"
    echo "  1. üì¶ Scans ~/Downloads for new .wbfs files"
    echo "  2. üöö Moves them to JWII/WBFS folder"
    echo "  3. üéÆ Converts to USB Loader GX format"
    echo "  4. üìÅ Creates: /wbfs/Game Name [GAMEID]/GAMEID.wbfs"
    echo ""
    echo "AUTO-WORKFLOW:"
    echo "  1. Download Wii game to ~/Downloads/"
    echo "  2. Run: wii"
    echo "  3. Plug USB (JWII) into Wii (bottom port)"
    echo "  4. Launch USB Loader GX"
    echo "  5. üéâ Play!"
    echo ""
    exit 0
}

# Show current paths
show_paths() {
    echo "$BORDER"
    echo "$BORDER_MID                  CURRENT DIRECTORY PATHS                 $BORDER_MID"
    echo "$BORDER_BOTTOM"
    echo ""
    echo "üéØ TARGETING: JWII (Your bigger USB drive)"
    echo ""
    echo "üìÅ Directory Structure:"
    echo "  /run/media/joud/JWII/"
    echo "  ‚îú‚îÄ‚îÄ üìÇ WBFS/           (Source .wbfs files)"
    echo "  ‚îî‚îÄ‚îÄ üìÇ wbfs/           (USB Loader GX organized games)"
    echo "      ‚îî‚îÄ‚îÄ üìÅ Game Name [GAMEID]/"
    echo "          ‚îî‚îÄ‚îÄ üéÆ GAMEID.wbfs"
    echo ""
    echo "üìç Current Paths:"
    echo "  üì• Downloads:      $DOWNLOADS_DIR"
    echo "  üì¶ Source WBFS:    $SOURCE_DIR"
    echo "  üéÆ USB Loader GX:  $DEST_DIR"
    echo "  üìù Log file:       $LOG_FILE"
    echo ""
    echo "üí° Your old WII drive would be at: /run/media/joud/WII/"
    echo "üí° Your new JWII drive is at:     /run/media/joud/JWII/"
    echo ""
    exit 0
}

# Show library status
show_status() {
    echo "$BORDER"
    echo "$BORDER_MID                  WII GAME LIBRARY STATUS                 $BORDER_MID"
    echo "$BORDER_BOTTOM"
    echo ""
    
    # Check if wit is installed
    if ! command -v wit &> /dev/null; then
        echo "‚ùå ERROR: 'wit' is not installed!"
        echo "Install with: sudo pacman -S wit"
        exit 1
    fi
    
    # Check directories
    echo "üìÅ Checking directories for JWII..."
    if [ ! -d "$SOURCE_DIR" ]; then
        echo "  ‚ö†Ô∏è  WBFS folder not found: $SOURCE_DIR"
        echo "  üí° Make sure your JWII USB is mounted!"
    else
        wbfs_count=$(find "$SOURCE_DIR" -maxdepth 1 \( -name "*.wbfs" -o -name "*.WBFS" \) 2>/dev/null | wc -l)
        echo "  ‚úÖ WBFS folder: $SOURCE_DIR ($wbfs_count .wbfs files waiting)"
    fi
    
    if [ ! -d "$DEST_DIR" ]; then
        echo "  ‚ö†Ô∏è  USB Loader GX folder not found: $DEST_DIR"
        echo "  üí° Will be created automatically when you run 'wii'"
    else
        game_count=$(find "$DEST_DIR" -name "*.wbfs" -type f 2>/dev/null | wc -l)
        folder_count=$(find "$DEST_DIR" -maxdepth 1 -type d -name "*[*]*" 2>/dev/null | wc -l)
        echo "  ‚úÖ USB Loader GX folder: $DEST_DIR ($game_count games in $folder_count folders)"
    fi
    
    # Show games in library
    if [ -d "$DEST_DIR" ] && [ $game_count -gt 0 ]; then
        echo ""
        echo "üéÆ Games in your JWII library:"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        
        # Look for game folders first (proper structure)
        found_folders=0
        find "$DEST_DIR" -maxdepth 1 -type d -name "*[*]*" 2>/dev/null | sort | while read dir; do
            if [ "$dir" != "$DEST_DIR" ] && [ -d "$dir" ]; then
                found_folders=1
                game=$(basename "$dir")
                size=$(du -sh "$dir" 2>/dev/null | cut -f1)
                count=$(find "$dir" -name "*.wbfs" -type f 2>/dev/null | wc -l)
                echo "  üéÆ $game ($size, $count file(s))"
            fi
        done
        
        # If no folders but games exist, show loose files
        if [ $found_folders -eq 0 ] && [ $game_count -gt 0 ]; then
            echo "  üìÑ Games found but not in folders (run 'wii' to organize):"
            find "$DEST_DIR" -maxdepth 1 -name "*.wbfs" -type f 2>/dev/null | head -5 | while read file; do
                filename=$(basename "$file")
                size=$(du -h "$file" 2>/dev/null | cut -f1)
                echo "    $filename ($size)"
            done
        fi
        
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "üìä Total: $game_count games ready for USB Loader GX"
    elif [ -d "$DEST_DIR" ] && [ $game_count -eq 0 ]; then
        echo ""
        echo "üì≠ No games found in USB Loader GX folder"
        echo "üí° Run 'wii' to organize your waiting games"
    fi
    
    # Check Downloads folder
    echo ""
    echo "üì• Downloads folder status:"
    dl_count=$(find "$DOWNLOADS_DIR" -maxdepth 1 \( -name "*.wbfs" -o -name "*.WBFS" \) 2>/dev/null | wc -l)
    if [ $dl_count -gt 0 ]; then
        echo "  ‚ö†Ô∏è  Found $dl_count .wbfs file(s) in Downloads"
        echo "  Run 'wii' to process them to your JWII drive!"
    else
        echo "  ‚úÖ Downloads folder is clean"
    fi
    
    # Show waiting games in WBFS folder
    if [ -d "$SOURCE_DIR" ] && [ $wbfs_count -gt 0 ]; then
        echo ""
        echo "‚è≥ Games waiting in WBFS folder:"
        find "$SOURCE_DIR" -maxdepth 1 \( -name "*.wbfs" -o -name "*.WBFS" \) 2>/dev/null | head -3 | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" 2>/dev/null | cut -f1)
            echo "  üì¶ $filename ($size)"
        done
        if [ $wbfs_count -gt 3 ]; then
            echo "  ... and $((wbfs_count - 3)) more"
        fi
        echo "  üí° Run 'wii' to organize these games"
    fi
    
    echo ""
    echo "üí° Tip: Run 'wii --paths' to see all directory locations"
    exit 0
}

# Clean up duplicate source files
clean_duplicates() {
    echo "$BORDER"
    echo "$BORDER_MID               CLEAN DUPLICATE SOURCE FILES               $BORDER_MID"
    echo "$BORDER_BOTTOM"
    echo ""
    echo "üéØ Cleaning duplicates from JWII drive"
    echo ""
    
    if [ ! -d "$SOURCE_DIR" ]; then
        echo "‚ö†Ô∏è  WBFS folder not found: $SOURCE_DIR"
        echo "üí° Is your JWII USB drive mounted?"
        exit 0
    fi
    
    removed=0
    kept=0
    
    find "$SOURCE_DIR" \( -name "*.wbfs" -o -name "*.WBFS" \) 2>/dev/null | while read file; do
        [ -f "$file" ] || continue
        
        # Get game ID
        game_id=$(wit ID6 "$file" 2>/dev/null)
        [ -z "$game_id" ] && continue
        
        # Check if this game already exists in USB Loader GX structure
        if find "$DEST_DIR" -name "$game_id.wbfs" -type f 2>/dev/null | grep -q .; then
            echo "  üóëÔ∏è  Removing duplicate: $(basename "$file") ‚Üí $game_id already exists"
            rm "$file"
            ((removed++))
        else
            ((kept++))
        fi
    done
    
    echo ""
    echo "üìä Cleanup complete:"
    echo "  Removed: $removed duplicate file(s)"
    echo "  Kept: $kept file(s)"
    echo ""
    echo "üí° Run 'wii' to organize the remaining files on your JWII drive!"
    exit 0
}

# Main conversion function
convert_to_usbloadergx() {
    log "üîç Searching for .wbfs files in JWII WBFS folder..."
    
    shopt -s nocaseglob
    files=("$SOURCE_DIR"/*.wbfs)
    shopt -u nocaseglob
    file_count=${#files[@]}
    
    if [ "$file_count" -eq 0 ]; then
        log "ü§∑ No .wbfs files found to convert!"
        return 0
    fi
    
    log "üéÆ Found $file_count game file(s) to convert"
    log "üîÑ Starting conversion..."
    
    processed=0
    skipped=0
    failed=0
    
    for file in "${files[@]}"; do
        [ -f "$file" ] || continue
        
        base_filename=$(basename "$file")
        log ""
        log "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        log "üîÑ Processing: $base_filename"
        log "   üìè Size: $(du -h "$file" | cut -f1)"
        
        # Get game ID
        game_id=$(wit ID6 "$file" 2>/dev/null)
        
        if [ -z "$game_id" ] || [ "$game_id" == "0" ]; then
            log "   ‚ùå ERROR: Invalid or corrupt .wbfs file"
            ((failed++))
            continue
        fi
        
        log "   üÜî Game ID: $game_id"
        
        # Get game title from filename
        game_title=$(basename "$file" .wbfs | basename "$file" .WBFS)
        game_title=$(echo "$game_title" | sed -E 's/\([^)]*\)//g')
        game_title=$(echo "$game_title" | sed 's/\[[^]]*\]//g')
        game_title=$(echo "$game_title" | sed 's/^\s*//;s/\s*$//')
        game_title=$(echo "$game_title" | sed 's/[-.\s]*$//')
        
        # Fallback titles for common games
        if [ -z "$game_title" ]; then
            case "$game_id" in
                RMCE*|RMCJ*|RMCK*|RMCP*) game_title="Mario Kart Wii" ;;
                RZDE*) game_title="The Legend of Zelda Skyward Sword" ;;
                R3BE*) game_title="The Legend of Zelda Twilight Princess" ;;
                SOUE*) game_title="Super Mario Galaxy" ;;
                SOUE02*) game_title="Super Mario Galaxy 2" ;;
                RZBE*) game_title="Super Smash Bros Brawl" ;;
                SX4E*) game_title="Xenoblade Chronicles" ;;
                R8BE*) game_title="Metroid Prime Trilogy" ;;
                RLSE*) game_title="New Super Mario Bros Wii" ;;
                R96E*) game_title="Donkey Kong Country Returns" ;;
                RQTE*) game_title="Kirby's Return to Dream Land" ;;
                RVLE*) game_title="Pikmin 2" ;;
                *) game_title="Wii Game $game_id" ;;
            esac
        fi
        
        # Clean title
        game_title=$(echo "$game_title" | sed 's/[<>:"/\\|?*]//g' | sed 's/\.$//')
        
        log "   üéÆ Game Title: $game_title"
        
        # Create folder
        folder_name="$game_title [$game_id]"
        dest_folder="$DEST_DIR/$folder_name"
        
        log "   üìÇ Creating folder: $folder_name"
        mkdir -p "$dest_folder"
        
        # Destination file
        dest_file="$dest_folder/$game_id.wbfs"
        
        # Check if already exists
        if [ -f "$dest_file" ]; then
            existing_size=$(du -h "$dest_file" | cut -f1)
            new_size=$(du -h "$file" | cut -f1)
            
            if [ "$existing_size" == "$new_size" ]; then
                log "   ‚ö†Ô∏è  SKIPPED: Already converted (same file)"
                ((skipped++))
            else
                log "   ‚ö†Ô∏è  Already exists but different size!"
                unique_name="${base_filename%.*}_$game_id.${base_filename##*.}"
                dest_file="$dest_folder/$unique_name"
                cp "$file" "$dest_file"
                new_size=$(du -h "$dest_file" | cut -f1)
                log "   ‚úÖ COPIED (unique): $unique_name ($new_size)"
                ((processed++))
            fi
        else
            if cp "$file" "$dest_file"; then
                new_size=$(du -h "$dest_file" | cut -f1)
                log "   ‚úÖ SUCCESS: $game_id.wbfs ($new_size)"
                ((processed++))
            else
                log "   ‚ùå ERROR: Copy failed!"
                ((failed++))
                rm -f "$dest_file" 2>/dev/null
            fi
        fi
    done
    
    log ""
    log "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    log "üìä CONVERSION RESULTS:"
    log "  Successfully converted: $processed"
    log "  Skipped (already exists): $skipped"
    log "  Failed: $failed"
    log "  Total files processed: $file_count"
    
    return $processed
}

# Move files from Downloads to WBFS folder
move_from_downloads() {
    log "üì¶ Checking Downloads folder for .wbfs files..."
    
    mkdir -p "$SOURCE_DIR"
    
    shopt -s nocaseglob
    download_files=("$DOWNLOADS_DIR"/*.wbfs)
    shopt -u nocaseglob
    download_count=${#download_files[@]}
    
    moved_count=0
    already_exists=0
    
    if [ "$download_count" -eq 0 ]; then
        log "‚úÖ No .wbfs files found in Downloads folder"
        return 0
    fi
    
    log "üîç Found $download_count .wbfs file(s) in Downloads"
    
    for file in "${download_files[@]}"; do
        [ -f "$file" ] || continue
        
        filename=$(basename "$file")
        dest_file="$SOURCE_DIR/$filename"
        
        log ""
        log "üìÑ Processing: $filename"
        log "   üìè Size: $(du -h "$file" | cut -f1)"
        
        if [ -f "$dest_file" ]; then
            existing_size=$(du -h "$dest_file" | cut -f1)
            new_size=$(du -h "$file" | cut -f1)
            
            if [ "$existing_size" == "$new_size" ]; then
                log "   ‚ö†Ô∏è  Already exists in JWII WBFS folder (same size)"
                log "   üóëÔ∏è  Removing from Downloads..."
                rm "$file"
                ((already_exists++))
            else
                log "   ‚ö†Ô∏è  Already exists but different size!"
                timestamp=$(date +%Y%m%d_%H%M%S)
                new_filename="${filename%.*}_$timestamp.${filename##*.}"
                dest_file="$SOURCE_DIR/$new_filename"
                mv "$file" "$dest_file"
                log "   üîÑ Renamed and moved as: $new_filename"
                ((moved_count++))
            fi
        else
            mv "$file" "$dest_file"
            log "   üöö Moved to JWII WBFS folder"
            ((moved_count++))
        fi
    done
    
    log ""
    log "üìä DOWNLOADS PROCESSING RESULTS:"
    log "  Moved: $moved_count new file(s)"
    log "  Skipped: $already_exists existing file(s)"
    
    return $moved_count
}

# Check if JWII drive is mounted
check_jwii_mounted() {
    if [ ! -d "/run/media/joud/JWII" ]; then
        echo "‚ùå ERROR: JWII drive not found at /run/media/joud/JWII/"
        echo ""
        echo "üîç Please check:"
        echo "  1. Is your USB drive plugged in?"
        echo "  2. Is it named 'JWII'? (case sensitive)"
        echo "  3. Did it mount automatically?"
        echo ""
        echo "üí° Try:"
        echo "  ls /run/media/joud/"
        echo "  # Should show: JWII"
        echo ""
        echo "üìå Your drive should be at: /run/media/joud/JWII/"
        exit 1
    fi
}

# Main function
main() {
    echo "$BORDER"
    echo "$BORDER_MID                WII GAME MANAGER v2.0                     $BORDER_MID"
    echo "$BORDER_MID                =====================                     $BORDER_MID"
    echo "$BORDER_MID              üéØ TARGETING: JWII DRIVE                    $BORDER_MID"
    echo "$BORDER_BOTTOM"
    echo ""
    
    # Check arguments
    case "$1" in
        "--help"|"-h")
            show_help
            ;;
        "--status"|"-s")
            show_status
            ;;
        "--clean"|"-c")
            clean_duplicates
            ;;
        "--paths"|"-p")
            show_paths
            ;;
        "")
            # Continue with normal operation
            ;;
        *)
            echo "‚ùå Unknown option: $1"
            echo "Use 'wii --help' for usage information"
            exit 1
            ;;
    esac
    
    # Check if JWII is mounted
    check_jwii_mounted
    
    # Check if wit is installed
    if ! command -v wit &> /dev/null; then
        echo "‚ùå ERROR: 'wit' is not installed!"
        echo "Install it with:"
        echo "  Ubuntu/Debian: sudo apt install wit"
        echo "  Arch: sudo pacman -S wit"
        echo "  Or download from: https://wit.wiimm.de/"
        exit 1
    fi
    
    echo "‚úÖ JWII drive detected at: /run/media/joud/JWII/"
    echo ""
    
    # Step 1: Move files from Downloads
    move_from_downloads
    moved_files=$?
    
    # Step 2: Convert to USB Loader GX
    echo ""
    convert_to_usbloadergx
    converted_files=$?
    
    # Final summary
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo "üèÅ WII MANAGER COMPLETE!"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    echo "üéØ All operations completed on your JWII drive!"
    echo ""
    
    if [ $moved_files -gt 0 ] || [ $converted_files -gt 0 ]; then
        # Show newly added games
        echo "üìã Recently added to JWII:"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        find "$DEST_DIR" -maxdepth 1 -type d -name "*[*]*" -mmin -5 2>/dev/null | sort | while read dir; do
            if [ "$dir" != "$DEST_DIR" ]; then
                game=$(basename "$dir")
                size=$(du -sh "$dir" 2>/dev/null | cut -f1)
                echo "  üéÆ $game ($size)"
            fi
        done | head -10
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    fi
    
    # Show total library count
    total_games=$(find "$DEST_DIR" -name "*.wbfs" -type f 2>/dev/null | wc -l)
    echo "üìà Total games on JWII drive: $total_games"
    echo ""
    echo "üéÆ Your JWII USB is ready! Plug it into Wii (bottom port)"
    echo "üöÄ Launch USB Loader GX and enjoy!"
    echo ""
    echo "üìù Log file: $LOG_FILE"
    echo ""
}

# Run main function
main "$@"
